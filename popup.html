<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Data Filler</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Fuse.js CDN for fuzzy matching -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="popup.css">
</head>
<body class="bg-gray-50 dark:bg-gray-900 flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-300 antialiased">
    <!-- Main Container with responsive sizing and shadows -->
    <div class="main-container bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-lg w-full border border-gray-200 dark:border-gray-700 relative transition-colors duration-300">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100 text-center mb-6 pb-2 border-b border-gray-200 dark:border-gray-700">Extension Features</h1>

        <!-- Dark Mode Toggle Switch -->
        <label class="theme-switch absolute top-4 right-4 md:top-6 md:right-6">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>

        <!-- Tab Buttons for switching features -->
        <div class="tab-buttons">
            <button id="autoFillTab" class="tab-button active">
                <i class="fas fa-file-excel mr-2"></i>Auto Fill
            </button>
            <button id="autoClickTab" class="tab-button">
                <i class="fas fa-mouse-pointer mr-2"></i>Auto Click
            </button>
        </div>

        <!-- Auto Fill Section: For uploading spreadsheets and filling forms -->
        <section id="autoFillSection" class="tab-content">
            <h2 class="section-heading text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"><i class="fas fa-magic mr-2 text-blue-500"></i>Auto Fill Data</h2>
            
            <!-- Step 1: Upload File Card -->
            <div class="card mb-6">
                <h3 class="card-heading text-md md:text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3"><i class="fas fa-upload mr-2 text-blue-500"></i>1. Upload File</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Supported: <span class="font-medium text-gray-700 dark:text-gray-300">.XLS, .XLSX, .ODS, .CSV, .XLSM, .XLSB.</span></p>
                
                <div class="drop-area" id="drop-area">
                    <!-- Hidden file input, triggered by the custom browse button -->
                    <input type="file" id="fileInput" class="hidden" accept=".xls,.xlsx,.ods,.csv,.xlsm,.xlsb" />
                    <p id="fileNameDisplay" class="text-gray-500 dark:text-gray-400 mb-1 group-hover:text-blue-700 dark:group-hover:text-blue-300 transition duration-300 ease-in-out">
                        Drag & Drop your file here, or
                    </p>
                    <!-- New element for row count -->
                    <p id="rowCountDisplay" class="text-gray-500 dark:text-gray-400 text-sm mb-4 hidden"></p>
                    <label for="fileInput" class="browse-button">
                        Browse File
                    </label>
                </div>
                
                <!-- File status message area -->
                <div id="fileStatusMessage" class="file-status mt-4 hidden">
                    <i id="fileStatusIcon" class="text-xl mr-3"></i>
                    <span id="fileMessage" class="text-lg font-medium"></span>
                </div>
            </div>

            <!-- Step 2: Data Display & Field Mapping Card -->
            <div id="dataDisplaySection" class="card hidden">
                <h3 class="card-heading text-md md:text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3"><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>2. Map Fields</h3>

                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">File Headers:</h4>
                    <div id="headersDisplay" class="headers-list">
                        <!-- Spreadsheet headers will be displayed here dynamically -->
                    </div>
                </div>

                <!-- Scan fields button -->
                <button id="scanFieldsButton" class="action-button emerald w-full mb-4">
                    <i class="fas fa-sync-alt mr-2"></i>Scan Current Tab for Fields
                </button>
                <!-- Message area for scan feedback -->
                <div id="scanMessage" class="message-box mt-3 hidden"></div>

                <!-- Field Mapping Section (visible after scan) -->
                <div id="fieldMappingSection" class="mt-4 hidden">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Available Form Field Groups:</h4>
                    <div id="mappingContainer">
                        <!-- Dynamic mapping dropdowns for each grouped field -->
                    </div>
                    <div class="flex items-center mt-4">
                        <label class="checkbox-label mr-3 text-sm">
                            <input type="checkbox" id="fillEmptyOnlyCheckbox" class="mr-2">
                            Fill only empty fields
                        </label>
                    </div>

                    <!-- Action buttons for testing and previewing -->
                    <div class="flex flex-col space-y-2 mt-4">
                        <button id="testFillButton" class="action-button secondary w-full">
                            <i class="fas fa-vial mr-2"></i>Test Fill First Row
                        </button>
                        <div id="testFillMessage" class="message-box mt-3 hidden"></div>
                        <button id="previewValuesButton" class="action-button secondary w-full">
                            <i class="fas fa-eye mr-2"></i>Preview Mapped Values
                        </button>
                        <div id="previewValuesMessage" class="message-box mt-3 hidden"></div>
                    </div>
                </div>
                
                <!-- Main fill data buttons -->
                <div class="flex flex-col space-y-3 mt-6">
                    <button id="fillDataButton" class="action-button primary w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Fill Data
                    </button>
                </div>
                
                <!-- Message area for fill data feedback -->
                <div id="fillDataMessage" class="message-box mt-3 hidden"></div>
            </div>
        </section>

        <!-- Auto Click Section: For automating button clicks -->
        <section id="autoClickSection" class="tab-content hidden">
            <h2 class="section-heading text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"><i class="fas fa-mouse-pointer mr-2 text-indigo-500"></i>Auto Click Buttons</h2>
            <!-- Message area for auto click feedback -->
            <div id="autoClickMessage" class="message-box mb-4 hidden"></div>
            
            <!-- Step 1: Scan for Clickable Elements Card -->
            <div class="card mb-6">
                <h3 class="card-heading text-md md:text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3"><i class="fas fa-search mr-2 text-indigo-500"></i>1. Scan for Clickable Elements</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Find buttons and other clickable elements on the current page.</p>
                <button id="scanButtons" class="action-button secondary w-full">
                    <i class="fas fa-sync-alt mr-2"></i>Scan for Clickable Buttons
                </button>
            </div>
            
            <!-- Step 2: Select a Button Card (visible after scan) -->
            <div id="selectButtonCard" class="card hidden mb-6">
                <h3 class="card-heading text-md md:text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3"><i class="fas fa-hand-pointer mr-2 text-indigo-500"></i>2. Select a Button</h3>
                <div id="clickableButtonsContainer" class="max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 p-2 mb-4">
                    <!-- Clickable buttons will be listed here dynamically as radio buttons -->
                    <p class="text-gray-500 dark:text-gray-400 text-sm p-2">No buttons found yet. Click 'Scan' above.</p>
                </div>
            </div>

            <!-- Step 3: Choose Number of Clicks & Execute Card (visible after scan) -->
            <div id="clickControlSection" class="card hidden">
                <h3 class="card-heading text-md md:text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3"><i class="fas fa-play-circle mr-2 text-indigo-500"></i>3. Choose Number of Clicks & Execute</h3>
                <label for="clickCount" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Number of clicks:</label>
                <input type="number" id="clickCount" value="1" min="1" class="mb-4 form-input" />
                <button id="startClicking" class="action-button primary w-full">
                    <i class="fas fa-bullseye mr-2"></i>Start Clicking
                </button>
            </div>
        </section>
    </div>

    <!-- SheetJS Library - NOW LOCAL -->
    <script src="xlsx.full.min.js"></script>
    <script src="popup.js"></script>
    <script>
        // Global error handler for better debugging in the popup context
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Global Error (popup.html):', { msg, url, lineNo, columnNo, error });
            const errorMessageElement = document.getElementById('fileStatusMessage') || document.getElementById('scanMessage') || document.getElementById('fillDataMessage') || document.getElementById('autoClickMessage');
            if (errorMessageElement) {
                // Display a user-friendly error message, avoiding specific internal details
                errorMessageElement.innerHTML = `<i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i><span class="text-lg font-medium">An unexpected error occurred. Please try again. If the issue persists, check the browser's console for more details.</span>`;
                errorMessageElement.className = 'file-status message-error';
                errorMessageElement.classList.remove('hidden');
                
                // Set a timeout to hide the error message after a few seconds
                setTimeout(() => {
                    errorMessageElement.classList.add('hidden');
                    errorMessageElement.innerHTML = '';
                }, 7000); // Increased visibility duration for critical errors
            }
        };
    </script>
</body>
</html>
